import os                                                  # import os module
import glob                                                # import glob module
import time                                                # import time module
import RPi.GPIO as GPIO
import smbus
import MySQLdb

db = MySQLdb.connect("localhost","root","aquaponic","aquaponic" )
cursor = db.cursor()

address = 0x48
A0 = 0x40
A1 = 0x41
A2 = 0x42
A3 = 0x43
A = [0x40, 0x41]
bus = smbus.SMBus(1)
value = [0]*2

GPIO.setmode(GPIO.BCM)
GPIO.setup(22, GPIO.IN, pull_up_down=GPIO.PUD_DOWN)
GPIO.setup(27, GPIO.IN, pull_up_down=GPIO.PUD_DOWN)
#print GPIO.input(22), GPIO.input(27)

os.system('modprobe w1-gpio')                              # load one wire communication device kernel modules
os.system('modprobe w1-therm')                                                 
base_dir = '/sys/bus/w1/devices/'                          # point to the address

device_folder = [0]*4
device_file = [0]*4
f = [0]*4
lines = [0]*4
equals_pos = [0]*4
temp_string = [0]*4
temp_c = [0]*4

for i in range(0,4):
	device_folder[i] = glob.glob(base_dir + '28*')[i]             # find device with address starting from 28*
	device_file[i] = device_folder[i] + '/w1_slave'                  # store the details
	print device_folder[i]

def read_temp_raw(i):
	   f[i] = open(device_file[i], 'r')
	   lines[i] = f[i].readlines()                                   # read the device details
	   f[i].close()
           return lines[i]

def read_temp(i):
	   lines[i] = read_temp_raw(i)
	   while lines[i][0].strip()[-3:] != 'YES':                   # ignore first line
	      time.sleep(0.2)
	      lines[i] = read_temp_raw(i)
	   equals_pos[i] = lines[i][1].find('t=')                        # find temperature in the details
	   if equals_pos[i] != -1:
	      temp_string[i] = lines[i][1][equals_pos[i]+2:]
	      temp_c[i] = float(temp_string[i]) / 1000.0                 # convert to Celcius
	      return temp_c[i]

while True:
	for i in range(0,2):
	    bus.write_byte(address,A[i])
	    value[i] = bus.read_byte(address)
	    time.sleep(0.1)
	print "AIN 1 : " + "{:.2f}".format(value[0]*5.0/255), "   AIN 2 : " + "{:.2f}".format(value[1]*5.0/255) +  " Limit 1 : " + str(GPIO.input(22)) + " Limit 2 : " + str(GPIO.input(27)) + "  T1 : " + str(read_temp(0)) , "  T2 : " + str(read_temp(1)) , "  T3 : " + str(read_temp(2)) , "  T4 : " + str(read_temp(3))
        sql = """INSERT INTO sensor_data(,
        	LAST_NAME, AGE, SEX, INCOME)
        	VALUES ('Mac', 'Mohan', 20, 'M', 2000)"""
	time.sleep(1)
